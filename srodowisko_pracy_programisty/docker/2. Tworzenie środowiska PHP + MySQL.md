# ğŸ•’ 2. Tworzenie Å›rodowiska PHP (60 min) â€“ Scenariusz Lekcji

## ğŸŒŸ Cel lekcji

W tej lekcji kontynuujemy pracÄ™ z plikiem docker-compose.yml zawierajÄ…cym usÅ‚ugÄ™ **MySQL** z poprzedniej lekcji. Teraz dodamy obsÅ‚ugÄ™ PHP i serwera HTTP (Nginx lub Apache), tworzÄ…c tym samym spÃ³jne Å›rodowisko do uruchamiania aplikacji.

---

## ğŸ“Œ Plan lekcji

### **1. ZaÅ‚oÅ¼enia z poprzedniej lekcji (5 min)**

- Mamy juÅ¼ plik docker-compose.yml zawierajÄ…cy usÅ‚ugÄ™ **MySQL** (np. `db:`) i sieÄ‡ app\_network.
- ZdefiniowaliÅ›my zmienne Å›rodowiskowe potrzebne do uruchomienia bazy danych (m.in. `MYSQL_ROOT_PASSWORD`, `MYSQL_DATABASE`).

PrzykÅ‚ad fragmentu z poprzedniej lekcji:

```yaml
version: "3.8"

services:
  db:
    image: mysql:latest
    container_name: mysql-container
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: testdb
      MYSQL_USER: user
      MYSQL_PASSWORD: password
    ports:
      - "3306:3306"
    networks:
      - app_network

volumes:
  db_data:

networks:
  app_network:
```

---

### **2. Wprowadzenie do kontenerÃ³w PHP (10 min)**

- OmÃ³wienie obrazu php dostÄ™pnego w Docker Hub.
- RÃ³Å¼nice miÄ™dzy php, php-cli i php-fpm.
- RÃ³Å¼nice miÄ™dzy `nginx` i `apache`.
- PrzykÅ‚adowe zastosowania PHP w aplikacjach webowych.

#### RÃ³Å¼nica miÄ™dzy php, php-cli i php-fpm

- **php** â€“ standardowa wersja PHP do uruchamiania kodu w serwerach aplikacyjnych.
- **php-cli** â€“ wersja PHP do uruchamiania skryptÃ³w z linii poleceÅ„, bez serwera [WWW](http://WWW).
- **php-fpm** â€“ wersja PHP zoptymalizowana pod serwery obsÅ‚ugujÄ…ce duÅ¼y ruch, dziaÅ‚a jako proces (demon) zarzÄ…dzajÄ…cy pulÄ… procesÃ³w PHP.

#### Apache â€“ serwer HTTP

- **Model pracy:** w trybie `prefork` lub `worker`, tworzy procesy (prefork) bÄ…dÅº wÄ…tki (worker) dla obsÅ‚ugi Å¼Ä…daÅ„.
- **ObsÅ‚uga plikÃ³w .htaccess:** umoÅ¼liwia konfigurowanie serwera w katalogach aplikacji.
- **ElastycznoÅ›Ä‡ i moduÅ‚owoÅ›Ä‡:** moÅ¼liwoÅ›Ä‡ dodawania rozszerzeÅ„ do obsÅ‚ugi cache, PHP, itp.
- **Zastosowanie:** czÄ™sto wybierany tam, gdzie potrzebne sÄ… dynamiczne konfiguracje .htaccess.

#### Nginx â€“ serwer HTTP

- **Model event-driven:** obsÅ‚uga wielu poÅ‚Ä…czeÅ„ jednoczeÅ›nie w jednym wÄ…tku, dziÄ™ki asynchronicznoÅ›ci.
- **Reverse proxy:** czÄ™sto wykorzystywany jako warstwa poÅ›redniczÄ…ca (proxy) przed backendem aplikacyjnym (PHP-FPM, Node.js).
- **Brak .htaccess:** konfiguracjÄ™ zmienia siÄ™ w centralnych plikach, co poprawia wydajnoÅ›Ä‡, ale wymaga restartu.
- **Zastosowanie:** Å›wietnie radzi sobie z serwowaniem plikÃ³w statycznych i wysokim ruchem.

**Kiedy wybraÄ‡ Apache, a kiedy Nginx?**

- Apache â€“ gdy potrzebna jest elastycznoÅ›Ä‡ .htaccess, czÄ™ste modyfikacje konfiguracji.
- Nginx â€“ w projektach z duÅ¼ym ruchem i duÅ¼Ä… liczbÄ… plikÃ³w statycznych.
- JeÅ›li uÅ¼ywasz php-fpm, Nginx czÄ™sto ma lepszÄ… integracjÄ™ niÅ¼ konfiguracja Apache + mod\_php.

---

### **3. Dodanie usÅ‚ugi PHP (15 min)**

Aby dodaÄ‡ kontener **PHP-FPM** do istniejÄ…cego pliku docker-compose.yml z poprzedniej lekcji, uzupeÅ‚niamy go o:

```yaml
services:
  db:
    # ... istniejÄ…ca konfiguracja MySQL

  php:
    image: php:8.2-fpm
    container_name: php-container
    volumes:
      - ../project:/var/www/html
    networks:
      - app_network
```

> **Opis:**
>
> - **image: php:8.2-fpm** â€“ oficjalny obraz PHP z wbudowanym FPM.
>
> - **../project:/var/www/html** â€“ wolumen, w ktÃ³rym kod aplikacji (PHP) jest udostÄ™pniany wewnÄ…trz kontenera.
>
> - **app\_network** â€“ sieÄ‡ wspÃ³Å‚dzielona z kontenerem MySQL (z poprzedniej lekcji).

---

### 4. Dodanie serwera Nginx

#### 4.1 Tworzenie pliku default.conf

Aby przygotowaÄ‡ konfiguracjÄ™ Nginx, najpierw tworzymy plik default.conf w katalogu docker/nginx:

```bash
mkdir -p docker/nginx
touch docker/nginx/default.conf
```

#### 4.2 PrzykÅ‚adowa minimalna konfiguracja Nginx (default.conf)

```nginx
server {
    listen 80;
    server_name localhost;

    # Katalog, w ktÃ³rym znajduje siÄ™ nasza aplikacja PHP
    root /var/www/html;
    index index.php;

    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    location ~ \.php$ {
        include fastcgi_params;
        fastcgi_pass php-container:9000;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_index index.php;
    }
}
```

#### 4.3 Dodanie Nginx do docker-compose.yml

W pliku docker-compose.yml (po usÅ‚udze db i php) dopisujemy:

```yaml
  nginx:
    image: nginx:latest
    container_name: nginx-container
    volumes:
      - ../project:/var/www/html
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
    ports:
      - "8080:80"
    networks:
      - app_network
```

> **Opis:**
>
> - default.conf â€“ plik konfiguracyjny Nginx. Musi byÄ‡ dostosowany do obsÅ‚ugi .php za pomocÄ… php-fpm (np. fastcgi\_pass php-container:9000;).

Po uruchomieniu:

```bash
docker compose up -d
```

Zobaczymy 3 kontenery: db (z poprzedniej lekcji), php i nginx.

### **5. Testowanie aplikacji (5 min)**

1. StwÃ³rz plik index.php w katalogu `../project`:
   ```php
   <?php
   phpinfo();
   ```
2. WejdÅº w przeglÄ…darce na [http://localhost:8080/index.php](http://localhost:8080/index.php) (lub innÄ… domenÄ™, jeÅ›li ustawiono).
3. PowinieneÅ› zobaczyÄ‡ stronÄ™ z informacjami o konfiguracji PHP.

---

### **RÃ³Å¼nice w konfiguracji php-cli i php-fpm**

- **php-cli** moÅ¼e uÅ¼ywaÄ‡ innej konfiguracji (`php.ini`) niÅ¼ **php-fpm**, co moÅ¼e prowadziÄ‡ do rÃ³Å¼nic w dziaÅ‚aniu skryptÃ³w.
- Aby sprawdziÄ‡ konfiguracjÄ™ uÅ¼ywanÄ… przez php-cli:
  ```bash
  php -i | grep 'Loaded Configuration File'
  ```
- Aby sprawdziÄ‡ konfiguracjÄ™ php-fpm, moÅ¼na stworzyÄ‡ plik phpinfo.php i uruchomiÄ‡ go w przeglÄ…darce:
  ```php
  <?php phpinfo(); ?>
  ```

---

### **ğŸ“ Podsumowanie lekcji (10 min)**

**Co uczestnicy osiÄ…gnÄ™li?**

- Rozszerzyli istniejÄ…cy plik docker-compose.yml z MySQL o serwer **PHP-FPM** oraz serwer HTTP (Nginx lub Apache).
- Zyskali kompletne Å›rodowisko do uruchamiania aplikacji PHP korzystajÄ…cej z MySQL.
- Nauczyli siÄ™, jak konfigurowaÄ‡ serwer Nginx w celu obsÅ‚ugi plikÃ³w PHP.

**Pytania i odpowiedzi** â€“ omÃ³wienie napotkanych problemÃ³w.

---

**Karol May Â© 2025**

