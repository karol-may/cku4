# ðŸ•’ 4. Komunikacja miÄ™dzy usÅ‚ugami i zarzÄ…dzanie kontenerami (45 min)

## ðŸŒŸ Cel lekcji

Po tej lekcji uczestnicy bÄ™dÄ… w stanie:

- PoÅ‚Ä…czyÄ‡ aplikacjÄ™ PHP i Reacta w Å›rodowisku Docker.
- PobieraÄ‡ dane z backendu w React za pomocÄ… API.

---

## ðŸ“Œ Plan lekcji

### 1. Teoria: Jak komunikujÄ… siÄ™ usÅ‚ugi? (20 min)

- **Jak PHP komunikuje siÄ™ z MySQL?**
  - PoÅ‚Ä…czenie przez PDO/MySQLi.
  - Zastosowanie `docker-compose.yml` do definiowania sieci miÄ™dzy usÅ‚ugami.
- **Jak frontend pobiera dane z backendu?**
  - Tworzenie API REST w PHP.
  - Fetchowanie danych w React.

---

### 2. Ä†wiczenie praktyczne (25 min)

#### 2.1. Tworzenie prostej API REST w PHP

Dodajemy plik `api.php` w katalogu `project/`:

```php
<?php
header("Access-Control-Allow-Origin: *");
header("Content-Type: application/json");

$host = 'mysql-container';
$db   = 'testdb';
$user = 'root';
$pass = 'root';
$charset = 'utf8mb4';

$dsn = "mysql:host=$host;dbname=$db;charset=$charset";
$options = [
    PDO::ATTR_ERRMODE            => PDO::ERRMODE_EXCEPTION,
    PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
    PDO::ATTR_EMULATE_PREPARES   => false,
];

try {
    $pdo = new PDO($dsn, $user, $pass, $options);
    $statement = $pdo->query("SELECT * FROM users");
    $data = $statement->fetchAll(PDO::FETCH_ASSOC);
    echo json_encode($data);
} catch (PDOException $e) {
    echo json_encode(["error" => "BÅ‚Ä…d poÅ‚Ä…czenia: " . $e->getMessage()]);
}
```

#### 2.2. Fetchowanie danych w React

Edytujemy `frontend/src/App.js`:

```jsx
import { useState, useEffect } from 'react';

function App() {
  const [users, setUsers] = useState([]);

  useEffect(() => {
    fetch("http://localhost:8080/api.php")
      .then(res => res.json())
      .then(data => setUsers(data))
      .catch(err => console.error(err));
  }, []);

  return (
    <div>
      <h1>Lista uÅ¼ytkownikÃ³w</h1>
      <ul>
        {users.map(user => (
          <li key={user.id}>{user.name} - {user.email}</li>
        ))}
      </ul>
    </div>
  );
}
export default App;
```

#### 2.3. Tworzenie tabeli i wprowadzanie danych z pliku SQL

##### 2.3.1. Tworzenie pliku `init.sql`

W katalogu `docker/mysql/` tworzymy plik `init.sql`:

```sql
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(100) NOT NULL UNIQUE
);

INSERT INTO users (name, email) VALUES
('Jan Kowalski', 'jan@example.com'),
('Anna Nowak', 'anna@example.com');
```

#### 2.3.2. Importowanie danych z pliku SQL

Po uruchomieniu kontenera dane moÅ¼na zaimportowaÄ‡ rÄ™cznie za pomocÄ… komendy `docker exec`:

```bash
docker exec -i mysql-container mysql -uuser -ppassword mydatabase < docker/mysql/init.sql
```

DziÄ™ki temu skrypt SQL zostanie wykonany w bazie danych po jej uruchomieniu.

Dodajemy Å›cieÅ¼kÄ™ do pliku SQL w `docker-compose.yml`, aby dane byÅ‚y Å‚adowane przy starcie kontenera:

```yaml
  db:
    volumes:
      - db_data:/var/lib/mysql
```
# ðŸ•’ 4. Komunikacja miÄ™dzy usÅ‚ugami i zarzÄ…dzanie kontenerami (45 min)

## ðŸŒŸ Cel lekcji

Po tej lekcji uczestnicy bÄ™dÄ… w stanie:

- PoÅ‚Ä…czyÄ‡ aplikacjÄ™ PHP i Reacta w Å›rodowisku Docker.
- PobieraÄ‡ dane z backendu w React za pomocÄ… API.

---

## ðŸ“Œ Plan lekcji

### 1. Teoria: Jak komunikujÄ… siÄ™ usÅ‚ugi? (20 min)

- **Jak PHP komunikuje siÄ™ z MySQL?**
  - PoÅ‚Ä…czenie przez PDO/MySQLi.
  - Zastosowanie `docker-compose.yml` do definiowania sieci miÄ™dzy usÅ‚ugami.
- **Jak frontend pobiera dane z backendu?**
  - Tworzenie API REST w PHP.
  - Fetchowanie danych w React.

---

### 2. Ä†wiczenie praktyczne (25 min)

#### 2.1. Tworzenie prostej API REST w PHP

Dodajemy plik `api.php` w katalogu `project/`:

```php
<?php
header("Content-Type: application/json");

$host = 'mysql-container';
$db   = 'testdb';
$user = 'root';
$pass = 'root';
$charset = 'utf8mb4';

$dsn = "mysql:host=$host;dbname=$db;charset=$charset";
$options = [
    PDO::ATTR_ERRMODE            => PDO::ERRMODE_EXCEPTION,
    PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
    PDO::ATTR_EMULATE_PREPARES   => false,
];

try {
    $pdo = new PDO($dsn, $user, $pass, $options);
    $statement = $pdo->query("SELECT * FROM users");
    $data = $statement->fetchAll(PDO::FETCH_ASSOC);
    echo json_encode($data);
} catch (PDOException $e) {
    echo json_encode(["error" => "BÅ‚Ä…d poÅ‚Ä…czenia: " . $e->getMessage()]);
}
```

Edytujemy `frontend/src/App.js`:

```jsx
import { useState, useEffect } from 'react';

function App() {
  const [users, setUsers] = useState([]);

  useEffect(() => {
    fetch("http://localhost:8080/api.php")
            .then(res => res.json())
            .then(data => setUsers(data))
            .catch(err => console.error(err));
  }, []);

  return (
          <div>
            <h1>Lista uÅ¼ytkownikÃ³w</h1>
            <ul>
              {users.map(user => (
                      <li key={user.id}>{user.name} - {user.email}</li>
              ))}
            </ul>
          </div>
  );
}
export default App;
```

### 2.4. Tworzenie tabeli i wprowadzanie danych z pliku SQL

#### 2.4.1. Tworzenie pliku `init.sql`

W katalogu `docker/mysql/` tworzymy plik `init.sql`:

```sql
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(100) NOT NULL UNIQUE
);

INSERT INTO users (name, email) VALUES
('Jan Kowalski', 'jan@example.com'),
('Anna Nowak', 'anna@example.com');
```

#### 2.4.2. Importowanie danych z pliku SQL

Po uruchomieniu kontenera dane moÅ¼na zaimportowaÄ‡ rÄ™cznie za pomocÄ… komendy `docker exec`:

```bash
docker exec -i mysql-container mysql -uuser -ppassword mydatabase < mysql/init.sql
```

DziÄ™ki temu skrypt SQL zostanie wykonany w bazie danych.


#### 2.4.3. Restartowanie bazy i sprawdzanie tabeli

Po dodaniu pliku restartujemy kontener bazy danych:

```bash
docker-compose down
docker-compose up -d db
```

Sprawdzamy zawartoÅ›Ä‡ tabeli:

```bash
docker exec -it mysql-container mysql testdb -uroot -proot -e "SELECT * FROM users;"
```

JeÅ›li wszystko dziaÅ‚a poprawnie, zobaczymy listÄ™ uÅ¼ytkownikÃ³w w bazie danych.


Po wejÅ›ciu na http://localhost:8080/api.php Jednak zobaczymy bÅ‚Ä…d `Uncaught PDOException: could not find driver`.

### 2.5. Tworzenie Dockerfile dla PHP
Aby uruchomiÄ‡ naszÄ… aplikacjÄ™ PHP w kontenerze, tworzymy plik `docker/php/Dockerfile`:
```dockerfile
FROM php:8.2-fpm
WORKDIR /var/www/html

# Instalacja rozszerzenia PDO MySQL
RUN docker-php-ext-install pdo pdo_mysql

EXPOSE 9000
CMD ["php-fpm"]
```

### 2.6. Dodanie PHP do `docker-compose.yml`
Modyfikujemy `docker-compose.yml`, aby dodaÄ‡ usÅ‚ugÄ™ PHP:
```yaml
  php:
    build:
      context: ../docker
      dockerfile: php/Dockerfile
    container_name: php-container
    volumes:
      - ../project:/var/www/html
    networks:
      - app_network
```

### 2.7. Uruchomienie kontenera PHP
Po dodaniu pliku `Dockerfile` i aktualizacji `docker-compose.yml`, uruchamiamy kontenery:
```bash
docker-compose up -d php
```

Sprawdzamy, czy kontener PHP dziaÅ‚a:
```bash
docker ps
```

JeÅ›li wszystko dziaÅ‚a poprawnie, serwer PHP powinien byÄ‡ uruchomiony w kontenerze.
## ðŸ“ Podsumowanie lekcji (5 min)

**Co uczestnicy osiÄ…gnÄ™li?**

- Stworzyli proste API REST w PHP.
- Pobierali dane w React przy pomocy `fetch`.

**Pytania i odpowiedzi** â€“ omÃ³wienie napotkanych problemÃ³w.

---

**Karol May Â© 2025**

